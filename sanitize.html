<html>
<head>
<title>Test pasting in contenteditable</title>
<script type="text/javascript">

function Sanitizer(){
  var i, e;
  this.options = {}
  this.options.elements = ['p', 'span', 'div'];
  this.options.attributes = {
      div:['id','contenteditable'],
      span:['class']
  }
  this.allowed_elements = {}
  for(i=0;i<this.options.elements.length;i++) {
    this.allowed_elements[this.options.elements[i]] = true;
  }
  this.allowed_attributes = {}
  for(e in this.options.attributes) {
      this.allowed_attributes[e] = {}
      for(i=0;i<this.options.attributes[e].length;i++) {
          this.allowed_attributes[e][this.options.attributes[e][i]] = true;
      }
  }
  console.log("aa:", this.allowed_attributes);
}

Sanitizer.prototype.clean = function(container) {
  var fragment = document.createDocumentFragment();
  var currentElement = fragment;
  var sanitizer = this;
  
  function _clean(elem) {
    var i, parentElement, name, attr;
    switch(elem.nodeType) {
      // Element
      case 1:
        // check if element itself is allowed
        parentElement = currentElement;
        name = elem.nodeName.toLowerCase()
        if(sanitizer.allowed_elements[name]) {
            currentElement = document.createElement(elem.nodeName);
            parentElement.appendChild(currentElement);
            
          // clean attributes
          if(sanitizer.allowed_attributes[name]) {
              for(i=0;i<elem.attributes.length;i++) {
                  attr = elem.attributes[i];
                  console.log("checking if ", attr.nodeName, " is allowed in ", name);
                  if(sanitizer.allowed_attributes[name][attr.nodeName]) {
                      currentElement.setAttribute(attr.nodeName, attr.nodeValue)
                  }
              }              
          }
          else {
              console.log(name, " has no allowed attributes");
          }
        }
        // iterate over child nodes
        for(i=0;i<elem.childNodes.length;i++) {
          _clean(elem.childNodes[i]);
        }
        currentElement.normalize();
        currentElement = parentElement;
        break;
      // Attribute
      case 2:
        // check if attribute name is in whitelist for this element
        break;
      // Text
      case 3:
        // TODO: replace unwanted text
        var clone = elem.cloneNode(false);
        currentElement.appendChild(clone);
        break;
      // Entity-Reference
      case 5:
        var clone = elem.cloneNode(false);
        currentElement.appendChild(clone);
        break;
      default:
        console.log("unknown node type", elem.nodeType)
    }
  }
  
  _clean(container);
  return fragment;
  
}

function do_sanitize() {
    console.log("Beginning sanitisation");
    var elm = document.getElementById('editarea');
    var s = new Sanitizer();
    var cleaned = s.clean(elm);
    elm.parentNode.replaceChild(cleaned, elm);
    document.forms['srcfrm'].elements['source'].value = document.getElementById('editarea').innerHTML;
}

window.onload = function() {
    document.getElementById('editarea').onpaste = function() {
        window.setTimeout(do_sanitize, 5);
        // todo: set selection cursor
        console.log("edit paste"); return true;
    };
    document.getElementsByTagName('body')[0].onpaste = function() {
        console.log("body paste"); return true;
    };
}


</script>
</head>
<body>
<div id="editarea" contenteditable="true">
<p>Some text</p>
<ul><li>List Item</li></ul>
<p><span class="foo">Inner Text.</span> Outer text. <a href="http://example.com/">Link</a></p>
</div>
<a href="javascript:do_sanitize();">Sanitize</a>
<form name="srcfrm" method="post" action="#">
    <textarea name="source" rows="30" cols="80"></textarea>
</form>
</body>
</html>
